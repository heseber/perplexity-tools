# Perplexity Tools

A collection of command-line tools for processing and converting Perplexity-generated markdown content, with special focus on proper citation formatting and PDF generation.

## Overview

This repository contains tools designed to handle the specific formatting challenges that arise when working with markdown content generated by Perplexity AI, particularly when converting to PDF with proper academic-style citations.

### Why These Tools Are Needed

While Perplexity AI offers a built-in PDF export feature for conversation threads, the exported PDFs have a significant limitation: **mathematical expressions are not rendered properly**. Instead of displaying formatted equations, the raw LaTeX commands are shown verbatim in the PDF, making mathematical content unreadable.

To generate PDFs with correctly rendered mathematical expressions, you need to:
1. Export your Perplexity conversation as **Markdown** (not PDF)
2. Use the tools provided in this repository to preprocess and convert the markdown to a properly formatted PDF

This workflow ensures that mathematical expressions, citations, and other academic formatting elements are rendered correctly in the final PDF output.

## Tools

### 1. `perplexity-preprocess-md.py`

A Python script that preprocesses markdown content to make it compatible with Pandoc's PDF conversion pipeline.

**Features:**
- Converts footnotes to proper Pandoc citations (`[^1]` → `[@ref1]`)
- Consolidates duplicate references automatically
- Fixes escaped math expressions (`\$ ... \$` → `$ ... $`)
- Converts HTML center divs to LaTeX centering commands
- Adds proper YAML front matter with bibliography entries
- Supports multiple languages for citations

**Usage:**
```bash
# Basic usage (reads from stdin, outputs to stdout)
cat input.md | python3 perplexity-preprocess-md.py > output.md

# With language specification
cat input.md | python3 perplexity-preprocess-md.py -l de-DE > output.md

# Skip font fallback configuration
cat input.md | python3 perplexity-preprocess-md.py --no-fallback-fonts > output.md

# Available language options: en-US, de-DE, or shortcuts: en, de
```

### 2. `perplexity-md-to-md`

A bash function that performs basic markdown preprocessing, specifically fixing escaped math expressions.

**Usage:**
```bash
# Convert a markdown file
perplexity-md-to-md input.md
# Creates input-fixed.md in the same directory
```

### 3. `perplexity-md-to-pdf`

A bash function that converts markdown files directly to PDF using Pandoc with optimized settings for academic documents.

**Features:**
- Automatic preprocessing using `perplexity-preprocess-md.py`
- Two-column landscape layout for saving paper, unless the markdown contains tables (tables enforce one-column output)
- Proper citation processing with `--citeproc`
- Uses LuaLaTeX engine for better Unicode support with fallback fonts
- Configurable font selection (default: FreeSans)
- Configurable language support

**Usage:**
```bash
# Convert to PDF with default settings (English)
perplexity-md-to-pdf document.md

# Convert with German language support
perplexity-md-to-pdf -l de document.md

# Convert with custom font
perplexity-md-to-pdf -f "Times New Roman" document.md

# Skip font fallback configuration
perplexity-md-to-pdf --no-fallback-fonts document.md

# Combine multiple options
perplexity-md-to-pdf -l de -f "DejaVu Serif" --no-fallback-fonts document.md

# Show help
perplexity-md-to-pdf --help
```

## Installation

### Prerequisites

- Python 3.6+
- Pandoc
- LuaLaTeX (usually comes with TeXLive or MiKTeX)
- Bash shell (for the shell functions)
- **Font requirements** (see Font Configuration section below)

### Setup

1. Clone this repository:
```bash
git clone <repository-url>
cd perplexity-tools
```

2. Run the automated installation script:
```bash
./install.sh
```

The installation script will:
- Install the Pandoc Lua filter (`longtable-to-table.lua`) to your Pandoc data directory
- Install the Python script (`perplexity-preprocess-md.py`) to your local binary directory
- Install the shell functions (`perplexity-md-to-md` and `perplexity-md-to-pdf`) to your shell function directory
- Detect your shell (bash/zsh) and provide instructions for loading the functions

3. Follow the instructions provided by the installer to add the shell functions to your shell configuration file (`~/.bashrc` or `~/.zshrc`).

4. Restart your shell or source your configuration file:
```bash
# For bash
source ~/.bashrc

# For zsh
source ~/.zshrc
```

## Font Configuration

### Required Fonts

By default, the tools add font fallback configuration to ensure proper rendering of emojis and special characters. The following fonts need to be installed on your system for PDF conversion to work without errors:

**Required fonts:**
- **FreeSans** - Default main font (required unless using `-f` option with a different font)
- **Noto Emoji** - For emoji and Unicode symbol support
- **DejaVu Serif** - Primary fallback font for serif text
- **FreeSerif** - Secondary fallback font

### Installing Fonts

#### macOS
```bash
# Install via Homebrew
brew install font-noto-emoji font-dejavu font-freefont

# Or download manually from:
# - FreeSans: https://www.gnu.org/software/freefont/
# - Noto Emoji: https://fonts.google.com/noto/specimen/Noto+Emoji
# - DejaVu: https://dejavu-fonts.github.io/
# - FreeSerif: https://www.gnu.org/software/freefont/
```

#### Linux (Ubuntu/Debian)
```bash
# Install via package manager
sudo apt-get install fonts-noto-emoji fonts-dejavu fonts-freefont-ttf
```

#### Windows
Download and install the fonts manually:
- [GNU FreeFont](https://www.gnu.org/software/freefont/) (includes FreeSans)
- [Noto Emoji](https://fonts.google.com/noto/specimen/Noto+Emoji)
- [DejaVu Fonts](https://dejavu-fonts.github.io/)

### Alternative: Disable Font Fallbacks

If you prefer not to install the additional fonts or want to use your own font configuration, you can disable the font fallback feature:

```bash
# Skip font fallback configuration
perplexity-md-to-pdf --no-fallback-fonts document.md

# Or when preprocessing manually
cat input.md | python3 perplexity-preprocess-md.py --no-fallback-fonts > output.md
```

**Note:** When using `--no-fallback-fonts`, you may encounter warnings about missing special symbols (emojis, Unicode characters) that cannot be rendered with the standard fonts. These symbols will not appear in the final PDF output.

**Important:** Even with `--no-fallback-fonts`, the default font **FreeSans** must still be installed on your system, unless you specify a different font using the `-f|--font` option.

## Workflow Examples

### Basic Markdown to PDF Conversion

```bash
# Simple conversion
perplexity-md-to-pdf my-document.md
```

### Advanced Workflow with Custom Processing

```bash
# Preprocess only
cat input.md | python3 perplexity-preprocess-md.py -l de > processed.md

# Manual Pandoc conversion with custom options
pandoc processed.md -o output.pdf --pdf-engine=lualatex --citeproc
```

### Batch Processing

```bash
# Convert multiple files
for file in *.md; do
    perplexity-md-to-pdf "$file"
done
```

## Citation Format

The tools automatically convert Perplexity's footnote format to Pandoc's citation system:

**Input (Perplexity format):**
```markdown
This is a claim[^1].

[^1]: https://example.com/source
```

**Output (Pandoc format):**
```markdown
This is a claim[@ref1].

---
references:
  - id: ref1
    type: webpage
    URL: https://example.com/source
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/nature.csl
lang: en-US
---
```

## Configuration

### Language Support

The tools support multiple languages for citation formatting:
- `en-US` (default) - English (United States)
- `de-DE` - German (Germany)
- `en` - Short form for English
- `de` - Short form for German

### Font Configuration

The `perplexity-md-to-pdf` function allows you to specify custom fonts:

```bash
# Use different fonts
perplexity-md-to-pdf -f "Times New Roman" document.md
perplexity-md-to-pdf -f "DejaVu Serif" document.md
perplexity-md-to-pdf -f "Liberation Sans" document.md

# Font names with spaces need quotes
perplexity-md-to-pdf -f "Computer Modern" document.md
```

**Note:** The specified font must be installed on your system. If the font is not available, LuaLaTeX will fall back to the default font (FreeSans) or show warnings.

**Default Font Requirement:** The default font **FreeSans** must be installed on your system unless you specify a different font with the `-f|--font` option. This requirement applies even when using `--no-fallback-fonts`.

### PDF Output Settings

The `perplexity-md-to-pdf` function uses these default settings:
- **Layout**: Two-column landscape (single-column portrait when tables are present)
- **Paper**: A4
- **Margins**: 2.5cm
- **Column separation**: 1cm
- **Font**: FreeSans (configurable with `-f|--font` option)
- **Engine**: LuaLaTeX
- **Font fallbacks**: Noto Emoji, DejaVu Serif, FreeSerif (can be disabled with `--no-fallback-fonts`)

## Troubleshooting

### Common Issues

1. **LuaLaTeX not found**: Install TeXLive or MiKTeX
2. **Pandoc not found**: Install Pandoc from [pandoc.org](https://pandoc.org/installing.html)
3. **Font issues**: 
   - Ensure the required fallback fonts are installed (see Font Configuration section)
   - **FreeSans must be installed** unless using `-f|--font` with a different font
   - Or use `--no-fallback-fonts` to skip font fallback configuration
   - Check that your system has the fonts specified in the YAML front matter
   - If using custom fonts with `-f|--font`, ensure the specified font is installed
4. **Permission denied**: Make sure the Python script is executable
5. **PDF conversion fails with font errors**: Install the required fonts or use `--no-fallback-fonts`

### Debug Mode

For troubleshooting, you can run the preprocessing step separately:

```bash
# Check the preprocessing output
cat input.md | python3 perplexity-preprocess-md.py -l en-US

# Then manually run Pandoc
pandoc processed.md -o output.pdf --pdf-engine=lualatex --citeproc
```

## Contributing

Contributions are welcome! Please feel free to submit issues, feature requests, or pull requests.

## License

This project is licensed under the BSD 3-Clause License - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

- Built for processing content generated by [Perplexity AI](https://perplexity.ai/)
- Uses [Pandoc](https://pandoc.org/) for document conversion
- Citation styles from [Citation Style Language](https://citationstyles.org/)
