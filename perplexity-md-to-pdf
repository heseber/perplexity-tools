perplexity-md-to-pdf() {
    local language="en-US"
    local font="FreeSans"
    local md_in=""
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -l|--language)
                language="$2"
                shift 2
                ;;
            -f|--font)
                font="$2"
                shift 2
                ;;
            -h|--help)
                echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] [-f|--font FONT] \
                    <markdown_file>"
                echo "  -l, --language LANGUAGE  Language code for citations"
                echo "                          (default: en-US)"
                echo "                          Use 'de' for German, 'en' for English"
                echo "  -f, --font FONT         Font name for PDF output"
                echo "                          (default: FreeSans)"
                echo "                          Use quotes for font names with spaces"
                echo "  -h, --help              Show this help message"
                return 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                echo "Use -h or --help for usage information" >&2
                return 1
                ;;
            *)
                if [[ -z "$md_in" ]]; then
                    md_in="$1"
                else
                    echo "Error: Multiple input files specified" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    # Check if input file is provided
    if [[ -z "$md_in" ]]; then
        echo "Error: No input file specified" >&2
        echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] [-f|--font FONT] \
            <markdown_file>" >&2
        return 1
    fi
    
    # Expand tilde in path if present
    md_in=$(eval echo "$md_in")
    
    # Check if input file exists
    if [[ ! -f "$md_in" ]]; then
        echo "Error: Input file '$md_in' does not exist" >&2
        return 1
    fi
    
    pdf_out=$(dirname "$md_in")/$(basename "$md_in" .md).pdf
    
    # Check if document contains tables
    has_tables=$(cat "$md_in" | grep -c "^|.*|")
    
    # Build pandoc command arguments
    pandoc_args=(
        --from=markdown
        --to=pdf
        -o "$pdf_out"
        --pdf-engine=xelatex
        --citeproc
        -V mainfont="$font"
        -V fontsize=10pt
        -V geometry:a4paper
        -V geometry:margin=2.5cm
    )
    
    if [ "$has_tables" -gt 0 ]; then
        # Use single column with portrait orientation for documents with tables
        pandoc_args+=(
           -V geometry:portrait
            --lua-filter=longtable-to-table.lua
        )
    else
        # Use two columns with landscape orientation for documents without tables
        pandoc_args+=(
            -V geometry:landscape
            -V geometry:columnsep=1cm
            -V classoption:twocolumn
            --lua-filter=longtable-to-table.lua
        )
    fi
    
    pandoc_args+=(
        --template eisvogel
        --syntax-highlighting=idiomatic
    )
    
    # Execute the command
    cat "$md_in" | perplexity-preprocess-md.py -l "$language" | \
        pandoc "${pandoc_args[@]}"
}
