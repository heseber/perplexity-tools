perplexity-md-to-pdf() {
    local language="en-US"
    local md_in=""
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -l|--language)
                language="$2"
                shift 2
                ;;
            -h|--help)
                echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] \
                    <markdown_file>"
                echo "  -l, --language LANGUAGE  Language code for citations"
                echo "                          (default: en-US)"
                echo "                          Use 'de' for German, 'en' for English"
                echo "  -h, --help              Show this help message"
                return 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                echo "Use -h or --help for usage information" >&2
                return 1
                ;;
            *)
                if [[ -z "$md_in" ]]; then
                    md_in="$1"
                else
                    echo "Error: Multiple input files specified" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    # Check if input file is provided
    if [[ -z "$md_in" ]]; then
        echo "Error: No input file specified" >&2
        echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] \
            <markdown_file>" >&2
        return 1
    fi
    
    # Expand tilde in path if present
    md_in=$(eval echo "$md_in")
    
    # Check if input file exists
    if [[ ! -f "$md_in" ]]; then
        echo "Error: Input file '$md_in' does not exist" >&2
        return 1
    fi
    
    pdf_out=$(dirname "$md_in")/$(basename "$md_in" .md).pdf
    
    # Check if document contains tables
    has_tables=$(cat "$md_in" | grep -c "^|.*|" || echo "0")
    
    # Build pandoc command arguments
    pandoc_args=(
        --from=markdown
        --to=pdf
        -o "$pdf_out"
        --pdf-engine=xelatex
        --citeproc
        -V mainfont="DejaVu Serif"
        -V geometry:a4paper
        -V geometry:margin=1.5cm
    )
    
    # Get the directory where this script is located
    # Use PERPLEXITY_TOOLS_DIR if set, otherwise try to detect it
    if [[ -n "$PERPLEXITY_TOOLS_DIR" ]]; then
        script_dir="$PERPLEXITY_TOOLS_DIR"
    else
        # Try to find the script directory by looking for the files
        script_dir=""
        
        # First try the hardcoded path
        if [[ -f "/Users/henrikseidel/projects/perplexity-tools/perplexity-preprocess-md.py" && -f "/Users/henrikseidel/projects/perplexity-tools/longtable-to-table.lua" ]]; then
            script_dir="/Users/henrikseidel/projects/perplexity-tools"
        else
            # Try to find it by looking for the actual script file
            local script_path
            script_path=$(find /Users/henrikseidel/projects -name "perplexity-md-to-pdf" -type f 2>/dev/null | head -1)
            if [[ -n "$script_path" ]]; then
                local found_dir
                found_dir=$(dirname "$script_path")
                if [[ -f "$found_dir/perplexity-preprocess-md.py" && -f "$found_dir/longtable-to-table.lua" ]]; then
                    script_dir="$found_dir"
                fi
            fi
        fi
        
        if [[ -z "$script_dir" ]]; then
            echo "Error: Cannot find perplexity-tools directory. Please set PERPLEXITY_TOOLS_DIR environment variable." >&2
            return 1
        fi
    fi
    
    if [ "$has_tables" -gt 0 ]; then
        # Use single column with portrait orientation for documents with tables
        pandoc_args+=(
            -V geometry:portrait
            --lua-filter="$script_dir/longtable-to-table.lua"
        )
    else
        # Use two columns with landscape orientation for documents without tables
        pandoc_args+=(
            -V geometry:landscape
            -V geometry:columnsep=1cm
            -V classoption:twocolumn
            --lua-filter="$script_dir/longtable-to-table.lua"
        )
    fi
    
    pandoc_args+=(
        --template eisvogel
        --syntax-highlighting=idiomatic
    )
    
    # Execute the command
    cat "$md_in" | "$script_dir/perplexity-preprocess-md.py" -l "$language" | \
        pandoc "${pandoc_args[@]}"
}
