perplexity-md-to-pdf() {
    local language="en-US"
    local md_in=""
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -l|--language)
                language="$2"
                shift 2
                ;;
            -h|--help)
                echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] \
                    <markdown_file>"
                echo "  -l, --language LANGUAGE  Language code for citations"
                echo "                          (default: en-US)"
                echo "                          Use 'de' for German, 'en' for English"
                echo "  -h, --help              Show this help message"
                return 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                echo "Use -h or --help for usage information" >&2
                return 1
                ;;
            *)
                if [[ -z "$md_in" ]]; then
                    md_in="$1"
                else
                    echo "Error: Multiple input files specified" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    # Check if input file is provided
    if [[ -z "$md_in" ]]; then
        echo "Error: No input file specified" >&2
        echo "Usage: perplexity-md-to-pdf [-l|--language LANGUAGE] \
            <markdown_file>" >&2
        return 1
    fi
    
    # Check if input file exists
    if [[ ! -f "$md_in" ]]; then
        echo "Error: Input file '$md_in' does not exist" >&2
        return 1
    fi
    
    pdf_out=$(dirname "$md_in")/$(basename "$md_in" .md).pdf
    
    # Check if document contains tables
    has_tables=$(cat "$md_in" | grep -c "^|.*|" || echo "0")
    
    # Build pandoc command
    pandoc_cmd="pandoc \
        --from=markdown \
        --to=pdf \
        -o \"$pdf_out\" \
        --pdf-engine=xelatex \
        --citeproc \
        -V mainfont=\"DejaVu Serif\" \
.        -V geometry:a4paper \
        -V geometry:margin=1.5cm"
    
    if [ "$has_tables" -gt 0 ]; then
        # Use single column with portrait orientation for documents with tables
        pandoc_cmd="$pandoc_cmd \
            -V geometry:portrait \
            -V geometry:columnsep=1cm \
            --lua-filter=longtable-to-table.lua"
    else
        # Use two columns with landscape orientation for documents without tables
        pandoc_cmd="$pandoc_cmd \
            -V geometry:landscape \
            -V geometry:columnsep=1cm \
            -V classoption:twocolumn \
            --lua-filter=longtable-to-table.lua"
    fi
    
    pandoc_cmd="$pandoc_cmd \
        --template eisvogel \
        --syntax-highlighting=idiomatic"
    
    # Execute the command
    cat "$md_in" | perplexity-preprocess-md.py -l "$language" | \
        eval "$pandoc_cmd"
}
